---
title: "Graph clustering with SBM"
author: "Etienne CÃ´me"
date: "`r Sys.Date()`"
fig_caption: yes
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Graph clustering with SBM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


Loads packages and set a future plan for parallel processing.
```{r}
library(future)
library(Matrix)
library(ggplot2)
library(greed)
plan(multisession)
```

Simulation of an SBM graph with a hierarchical structure.
```{r, fig.show='hold'}
N=1500
K=15
pi=rep(1/K,K)
lambda  = 0.1
lambda_o = 0.01
Ks=5
mu = bdiag(lapply(1:(K/Ks), function(k){matrix(lambda_o,Ks,Ks)+diag(rep(lambda,Ks))}))+0.001
sbm = rsbm(N,pi,mu)
```

Perform the clustering with default model and algorithm. An sbm model is used for squared matrix and a genetic algorithm is selected by default. The second parameter is just an itnitial guess for the number of cluster.

```{r}
sol = greed(sbm$x,model=new("sbm"))
```
Plot the results using a block representation.

```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
plot(sol,type='blocks')
```

Improvement of hybrid algoritithm with respect to multiple start is clearly visible :

```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
ggplot()+geom_boxplot(data=sol@train_hist,aes(x=generation,group=generation,y=icl))
```



Plot the results with a node link diagram.
```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
plot(sol,type='nodelink')
```
Or a dendogram for sleecting a smaller value for K.
```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
plot(sol,type='tree')
```
Eventually study the evolution of $-log(\alpha)$ with respect to $K$.
```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
plot(sol,type='path')
```

And select a smaller value to extract a new solution.
```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
sol3 = cut(sol,3)
plot(sol3,type='blocks')
```

Other model are availbale dscbm, mm
```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
soldc = greed(sbm$x,25,new("dcsbm"))
plot(soldc,type='blocks')
```

Eventualy you may change the algorithm "hybrid" (default), "multistart" greedy with random multiple start and "seed"" greed initialized with spectral clustering. See the doc for details on the algorithm parameters. 


One example with the polbooks dataset:
```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
data("Xpolbooks")
solpol=greed(Xpolbooks,10,new("dcsbm"),new("hybrid",pop_size=30))
plot(solpol,type='blocks')
```


```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
data("Lpolbooks")
plot(solpol,type='path')
table(Lpolbooks,cut(solpol,3)@cl)
```


One with the polblogs dataset:
```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
data("Xpolblogs")
solblogs=greed(Xpolblogs)
plot(solblogs,type='blocks')
```

```{r, fig.show='hold',out.width="70%",fig.width=8,fig.height=5.5}
data("Lpolblogs")
plot(solblogs,type='tree')
table(Lpolblogs,cut(solblogs,2)@cl)
```
