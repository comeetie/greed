---
title: "Latent class analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Latent class analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Loads packages.
```{r setup,message=FALSE}
library(dplyr)
library(stringr)
library(careless)
library(greed)
library(ggplot2)
library(purrr)
library(ggwordcloud)
#https://www.kaggle.com/miroslavsabo/young-people-survey
#survey=read_csv("data-raw/responses.csv")
data("Youngpeoplesurvey")
```

## Young people survey data
We begin by preprocessing the data, only keeping the categorical variable. The original dataset has $n=`r nrow(Youngpeoplesurvey)`$ respondents for $p=`r ncol(Youngpeoplesurvey)`$.

```{r}
nc  = 19

selected = Youngpeoplesurvey %>% 
  select(all_of(1:nc)) %>%
  mutate(string = longstring(.)) %>%
  mutate(sel = if_else(string <= 10,TRUE,FALSE) ) %>% pull(sel)

Xnum = Youngpeoplesurvey %>% 
  select(all_of(1:nc)) %>%
  filter(all_of(selected) )

X = Xnum %>% 
  mutate_all(\(x){factor(x,levels=1:5)}) %>% 
  droplevels()

X = X[rowSums(is.na(X))==0,]

```

```{r survey-lca-cust,fig.show='hold',out.width="100%",fig.width=8,fig.height=5.5}
set.seed(31)
library(future)
plan(multisession)
sol=greed(X,alg=Seed(),K=10)
plot(sol,type='tree')
```



```{r, fig.show='hold',out.width="60%",fig.width=8,fig.height=6}
table(clustering(sol))
```

```{r posplot, fig.show='hold',fig.width=8,fig.height=7,out.width="100%"}
params = coef(sol)
means_scores = lapply(params$Thetak,\(x){apply(x,1,\(r){sum(r*as.numeric(names(r)))})})
means_scores_long = do.call(rbind,map2(means_scores,names(means_scores),\(x,y){tibble(cluster=names(x),mean=x,var=y)}))  %>% mutate(var = gsub("\\."," ",var))

means_scores_glob = Xnum %>% 
  summarise_all(\(x){mean(x,na.rm=TRUE)}) %>% 
  tidyr::pivot_longer(1:nc,names_to = "var",)%>% 
  mutate(var = gsub("[,-/]"," ",var))

gg = means_scores_long %>% 
  left_join(means_scores_glob) %>% 
  mutate(dm=mean-value) 


ggplot(gg %>% filter(abs(dm)>0.1), aes(label = var, size = abs(dm),color=dm)) +
  geom_text_wordcloud() +
  scale_size_area(max_size = 5) +
  theme_minimal() +
  scale_color_gradient2(guide="none")+
  facet_wrap(~cluster)



```

